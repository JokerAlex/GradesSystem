<!doctype html>
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<link rel="stylesheet" href="css/bootstrap.min.css">
<link rel="stylesheet" href="css/button.css">
<script src="https://apps.bdimg.com/libs/jquery/2.1.4/jquery.min.js"></script>
<script type="text/javascript" src="js/jquerycookie.js"></script>
</head>
<body>
<div class="container" style="height:600px">
<div class="row">
<div class=col-md-3><button id="btn1" class="button" style="border-radius:10%;height:50px;width:70%">新建查询</button></div>
<div class=col-md-3><button id="btn2" class="button" style="border-radius:10%;height:50px;width:70%">查询列表</button></div>
<div class=col-md-3><button id="btn3" class="button" style="border-radius:10%;height:50px;width:70%">个人信息</button></div>
<div class=col-md-3><button id="btn4" class="button" style="border-radius:10%;height:50px;width:70%">发布列表</button></div>
<div ><span id="welcomespan" style="float: right;color:grey;font-size:17px">"用户名获取栏"</span></div>
</div>
<!--登陆框框-->

  <div style="overflow:hidden;margin:0 auto;margin-top:5%; width:50%; height:100%; background-color: #FAFAFA;border-radius:5%;opacity: 0.9">
    <form id="uploadForm" enctype="multipart/form-data">
      <div class="form-group " style="margin:0 auto; margin-top:20%; width:80%">
        <center><h1>新建查询</h1></center>
        <hr style="width:300px;height:1px;border:none;border-top:1px solid #d6d6d6;"/>
        <input type="text" class="form-control " id="listname" name="tableName" placeholder="设置名称如第一学期期末成绩" onblur="checklistname()">
        <span id="listnamestatus" style="float: right;">test</span>
        <br>
        <label for="exampleInputFile">File input</label>
        <input type="file" id="file" name="file">
      </div>
      <br>
      <div class="progress" style="margin:0 auto; width:80%">
          <div class="progress-bar progress-bar-striped active" role="progressbar" aria-valuemin="0" aria-valuemax="100" style="width: 0%">
          </div>
      </div>
      <div style="margin:0 auto; width:80%;text-align: center" id="progress_reminder">
        <span>adasdasd</span>
      </div>
      <center><button type="button" class="btn btn-default" id="sub" style="width:80%">Submit</button></center>
    </form>
      <!--<iframe id="id_iframe" name="nm_iframe" style="display:none;"></iframe>-->
  </div>
</div>

<script type="text/javascript">

// var testgetusername = "";
//   $(document).ready(function(){
//     //GET username
//     $.ajax({
//           type : "get",
//           url : "" ,
//           async : true,
//           contentType: "application/json;charset=utf-8",
//           dataType: "json",
//           success: function (data) {
//           var json = eval(data);
//           $.cookie('testgetusername','json.userName');
//           testgetusername = "welcome&nbsp&nbsp"+json.userName+"!";
//           console.log(testgetusername);
//         },
//       error:function (data) {
//         testgetusername = "用户名无法获取";
//       }
//     });
//   });
  //设置用户名欢迎栏以及登出
  // $("#welcomespan").mouseenter(function(){
  //   $(this).html("log out?");
  // });
  // $("#welcomespan").mouseleave(function(){
  //   $(this).html(testgetusername);
  // });
  // $("#welcomespan").click(function(){
  //   window.location.href="login.html";
  // });


  function checklistname(){
      // $("div.form-group").removeClass("has-error");
      // $("div.form-group").addClass("has-success");
      $.ajax({
          type : "post",
          url : "/GradesSystem/checkTableName" ,
          async : true,
          data:$("#listname").val(),
          contentType: "application/json;charset=utf-8",
          dataType: "json",
          success: function (data) {
          var json = eval(data);
          var isavailable = json.isAvailable;
          console.log(isavailable);
          if(isavailable == "true"){
            $("div.form-group").removeClass("has-error");
            $("div.form-group").addClass("has-success");
            $("#listnamestatus").css("color","#5bec22");
            $("#listnamestatus").html("该表名可用");
            $("#listnamestatus").show();
          }
          else{ 
            $("div.form-group").removeClass("has-success");
            $("div.form-group").addClass("has-error");
            $("#listnamestatus").css("color","#ed0718");
            $("#listnamestatus").html("该表名不可用");
            $("#listnamestatus").show();
          }
        },
      error:function (data) {
      }
  });

  var listname = $("#listname").val();
  var fileinput= $("#listfile").val();
  if(listname!="" && fileinput!="")$("#sub").attr("disabled",false);
  console.log(listname+fileinput);
  }

  function checktablenull(){
      var listname = $("#listname").val();
      var fileinput= $("#listfile").val();
      if(listname!="" && fileinput!="")$("#sub").attr("disabled",false);
  }

  function uploadfile(){
      var formData = new FormData($("#uploadForm")[0]);
    $.ajax({
          url : "/GradesSystem/upload.do",
          type : "post",
          async : false,
          data : formData,
          processData : false,
          contentType : false,
          beforeSend : function(){
            console.log("正在上传");
          },
          success : function(data){
              console.log("-----aaaa----");
            var json = eval(data);
            var uploadResult = json.uploadResult;
            if(uploadResult == "true"){
              window.location.href = "QueryListPtea.html";
            }
            //progress();
          },
          error : function(){
            console.log("------------error!-----------");
          }
    });
  }

  function progress(){
    $.ajax({
          type : "get",
          url : "/GradesSystem/getUploadStatus" ,
          async : true,
          contentType: "application/json;charset=utf-8",
          dataType: "json",
          success: function (data) {
          var json = eval(data);
          var uploadStatus = parseInt(json.uploadStatus);
          var readProgress = parseFloat(json.readProgress);
          var writeProgress = parseFloat(json.writeProgress);
          var errorCode = parseInt(json.errorCode);
          if(errorCode == 1){
            if(uploadStatus == 0){
              //未上传完成 do nothing
            }
            else if(uploadStatus == 1){
              //读取进度条
                console.log(readProgress);
              $("div.progress-bar").css("width",readProgress+'%');
              $("#progress_reminder").text("正在读取文件");
            }
            else if(uploadStatus == 2){
              //写入进度条
              $("div.progress-bar").css("width",writeProgress+'%');
              $("#progress_reminder").text("正在写入数据库");
              if(writeProgress == 100.0){
                  alert("写入成功!");
              }
            }
          }
          else{
              alert(json.errorInfo);
              return false;
          }
        },
      error:function (data) {
      }
  });
    setTimeout(progress,10);
  }

  $(document).ready(function(){
      $("#progress_reminder").hide();
      $("div.progress").hide();
      $("#listnamestatus").hide();
      $("#sub").attr("disabled",true);
      $("#listfile").on("change",function(){
          checktablenull();
      });
      $("#sub").click(function(){
        $("div.progress").show();
        $("#progress_reminder").show();
        $("#sub").hide();
        progress();
        uploadfile();
      });
  });
//导航栏
$(document).ready(function(){
    $(".button:lt(4)").mouseenter(function(){
      $(this).css("height","300px")
    });
    $(".button:lt(4)").mouseleave(function(){
      $(".button:lt(4)").css("height","50px")
    });
    
    $("#btn1").click(function(){
      window.location.href="new_search.html"
    });
    $("#btn2").click(function(){
      window.location.href="QueryListPtea.html"
    });
    $("#btn3").click(function(){
      window.location.href="personal_info.html"
    });
    $("#btn4").click(function(){
      window.location.href="history.html"
    });
  });
</script>
</body>
</html>
